<script>
    // Firebase Config (ensure this matches your project)
    const firebaseConfig = {
        apiKey: "AIzaSyCe33YSO0AKQ419ZIT_rhmE3LPFC2KU4ys",
        authDomain: "rg-marine-v2.firebaseapp.com",
        projectId: "rg-marine-v2",
        storageBucket: "rg-marine-v2.firebasestorage.app",
        messagingSenderId: "1029678913953",
        appId: "1:1029678913953:web:62bfba90a0f30b3ce7d3e0"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    const auth = firebase.auth();

    // DOM Elements
    const form = document.getElementById('intake-form');
    const itemNameInput = document.getElementById('item-name');
    const itemNumberInput = document.getElementById('item-number');
    const categoryInput = document.getElementById('category');
    const quantityInput = document.getElementById('quantity');
    const priceInput = document.getElementById('price');
    const locationInput = document.getElementById('location');
    const imageInput = document.getElementById('image-upload');
    const successMessage = document.getElementById('success-message');

    // Ensure user is signed in before allowing form submission
    auth.onAuthStateChanged(user => {
        if (!user) {
            console.log("User is not signed in. Redirecting to login.");
            // Optional: Redirect to login page if you want to enforce login for this page
            // window.location.href = 'index.html'; 
        } else {
            console.log("User is signed in:", user.uid);
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        successMessage.style.display = 'none'; // Hide previous success messages

        const itemData = {
            itemName: itemNameInput.value,
            itemNumber: itemNumberInput.value,
            category: categoryInput.value,
            quantity: Number(quantityInput.value),
            price: Number(priceInput.value),
            location: locationInput.value,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        const imageFile = imageInput.files[0];

        try {
            // --- NEW LOGIC STARTS HERE ---
            if (imageFile) {
                // CASE 1: An image file was selected
                console.log("Image found, starting upload...");
                const imageRef = storage.ref(`inventory_images/${Date.now()}_${imageFile.name}`);
                const snapshot = await imageRef.put(imageFile);
                const downloadURL = await snapshot.ref.getDownloadURL();

                itemData.imageUrl = downloadURL; // Add image URL to our data
                console.log("Image uploaded successfully. URL:", downloadURL);

            } else {
                // CASE 2: No image file was selected
                console.log("No image selected, skipping upload.");
                itemData.imageUrl = ''; // Set image URL to an empty string
            }

            // --- SAVE DATA TO FIRESTORE ---
            console.log("Saving data to Firestore:", itemData);
            await db.collection('inventory').add(itemData);

            // --- Show success and reset form ---
            console.log("Document successfully written!");
            successMessage.style.display = 'block';
            form.reset();

        } catch (error) {
            console.error("Error adding document: ", error);
            alert("An error occurred. Please check the console for details.");
        }
    });
</script>